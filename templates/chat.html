<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/png">
    <title>青鸾向导</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <!-- 添加了以下代码 -->
</head>
<body>
    <div class="chat-container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="{{ url_for('static', filename='icon.png') }}" alt="Profile Picture" style="border-radius: 50%; width: 33.3px; height: 33.3px;">
                <h1>青鸾向导</h1>
            </div>
            <div class="user-info">
                <span style="font-weight:bold;">{{ email }}</span>
                <a href="/logout" class="logout-btn">退出</a>
            </div>
        </header>

        <div style="padding:0 20px;">
            <div style="display:flex; justify-content:space-between; margin:15px 0;">
                <div style="display:flex; gap:10px;">
                    <button id="new-chat-btn" style="background:none; border:none; color:var(--primary-color); cursor:pointer; display:flex; align-items:center; gap:5px;">
                          🆕 新建对话
                    </button>
                    <button id="history-btn" style="background:none; border:none; color:var(--primary-color); cursor:pointer; display:flex; align-items:center; gap:5px;">
                          📜 历史对话
                    </button>
                </div>
                <div style="color:var(--dark-color); font-size:0.9rem;">
                    <span id="current-time">加载中...</span>
                </div>
            </div>
        </div>

        <hr style="margin:0; border: none; border-top: 1px solid #e0e0e0;">

        <!-- 聊天框 -->
        <body>
            <div class="chat-box" id="chat-box">
                <div id="requirements-container"></div>
            </div>
            <script src="{{ url_for('static', filename='script.js') }}"></script>
        </body>

        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="message-input" placeholder="请输入信息..." rows="2"></textarea>
                <button id="send-btn">发送</button>
            </div>
        </div>
    </div>

    <!-- 历史对话弹窗 -->
    <div id="history-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background-color:white; width:90%; max-width:600px; border-radius:10px; overflow:hidden; box-shadow:0 5px 30px rgba(0,0,0,0.2);">
            <div style="padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color:var(--primary-color);">历史对话</h3>
                <button id="close-history" style="background:none; border:none; color:var(--dark-color); cursor:pointer;">✖</button>
            </div>
            <div style="height:500px; overflow-y:auto; padding:15px; background-color:#f9f9f9;">
                <div id="history-list">
                    <div style="text-align:center; color:#999; padding:20px;">加载中...</div>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid #eee; text-align:right;">
                <button id="clear-history" style="margin-right:10px; padding:8px 15px; background-color:#f8f9fa; border:1px solid #ddd; border-radius:5px; cursor:pointer;">清除历史</button>
                <button id="close-history-btn" style="padding:8px 15px; background-color:var(--primary-color); color:white; border:none; border-radius:5px; cursor:pointer;">关闭</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
        updateTime();
        setInterval(updateTime, 60000);
        // 添加复制按钮函数
        function addCopyButtons() {
            document.querySelectorAll('.ai-message pre').forEach(pre => {
                if (pre.dataset.hasCopy === 'true') return;

                pre.style.position = 'relative';
                const btn = document.createElement('button');
                btn.innerText = '复制';
                btn.className = 'copy-btn';

                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(pre.innerText.replace('复制','').trim()).then(() => {
                        btn.innerText = '已复制';
                        setTimeout(() => btn.innerText = '复制', 2000);
                    });
                });

                pre.appendChild(btn);
                pre.dataset.hasCopy = 'true';
            });
        }

        // 初始高亮和添加按钮
        document.addEventListener('DOMContentLoaded', () => {
            hljs.highlightAll();
            addCopyButtons();
        });
        
        // 监听 DOM 变化自动添加复制按钮和高亮代码
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // 为新添加的代码块应用高亮
                            const codeBlocks = node.querySelectorAll ? node.querySelectorAll('pre code') : [];
                            codeBlocks.forEach(block => {
                                if (!block.className.includes('language-')) {
                                    block.className = 'language-javascript';
                                }
                                hljs.highlightElement(block);
                            });
                            
                            // 为新添加的行内代码应用高亮
                            const inlineCodes = node.querySelectorAll ? node.querySelectorAll('code:not(pre code)') : [];
                            inlineCodes.forEach(code => {
                                if (!code.className.includes('language-')) {
                                    code.className = 'language-javascript';
                                }
                                hljs.highlightElement(code);
                            });
                            
                            // 确保所有代码元素都被正确高亮
                            const allCodes = node.querySelectorAll ? node.querySelectorAll('code') : [];
                            allCodes.forEach(code => {
                                if (!code.classList.contains('hljs')) {
                                    hljs.highlightElement(code);
                                }
                            });
                            
                            // 为新添加的pre元素添加复制按钮
                            const preElements = node.querySelectorAll ? node.querySelectorAll('pre') : [];
                            preElements.forEach(pre => {
                                if (!pre.dataset.hasCopy) {
                                    addCopyButtons();
                                }
                            });
                        }
                    });
                }
            });
        });
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>