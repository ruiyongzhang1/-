<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/png">
    <title>é’é¸¾å‘å¯¼ - æ—…è¡Œè§„åˆ’</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='travel.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="travel-layout">
    <!-- å·¦ä¾§è¡¨å• -->
    <aside class="travel-form-panel">
        <div class="logo-title" style="text-align: center; margin-bottom: 20px;">
            <img src="{{ url_for('static', filename='icon.png') }}" alt="é’é¸¾å‘å¯¼" class="logo" style="width: 40px; height: 40px; border-radius: 50%;">
            <h2 style="margin: 10px 0; color: var(--primary-color);">æ™ºèƒ½æ—…è¡Œè§„åˆ’</h2>
        </div>
        <form id="travelForm">
            <div class="form-section">
                <h3 class="section-title">ğŸ“ åŸºæœ¬ä¿¡æ¯</h3>
                <div class="form-group">
                    <input type="text" class="form-control" id="source" placeholder="å‡ºå‘åœ° ä¾‹ï¼šåŒ—äº¬" required>
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" id="destination" placeholder="ç›®çš„åœ° ä¾‹ï¼šä¸œäº¬" required>
                </div>
                <div class="form-group">
                    <div style="display: flex; gap: 10px;">
                        <input type="date" class="form-control" id="start_date" required>
                        <input type="date" class="form-control" id="end_date" required>
                    </div>
                </div>
                <div class="form-group">
                    <input type="number" class="form-control" id="budget" placeholder="äººå‡é¢„ç®—ï¼ˆäººæ°‘å¸ï¼‰ä¾‹ï¼š1000" min="0" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">æ—…è¡Œäººæ•°</label>
                    <input type="number" class="form-control" id="traveler_count" placeholder="ä¾‹ï¼š2" min="1" value="1" required>
                </div>
            </div>
            <div class="form-section">
                <h3 class="section-title">â¤ï¸ æ—…è¡Œåå¥½</h3>
                <div id="preferences" class="preference-tags">
                    <span class="preference-tag" data-value="æ–‡åŒ–å†å²">æ–‡åŒ–å†å²</span>
                    <span class="preference-tag" data-value="è‡ªç„¶é£å…‰">è‡ªç„¶é£å…‰</span>
                    <span class="preference-tag" data-value="ç¾é£Ÿä½“éªŒ">ç¾é£Ÿä½“éªŒ</span>
                    <span class="preference-tag" data-value="è´­ç‰©å¨±ä¹">è´­ç‰©å¨±ä¹</span>
                    <span class="preference-tag" data-value="å†’é™©è¿åŠ¨">å†’é™©è¿åŠ¨</span>
                    <span class="preference-tag" data-value="ä¼‘é—²æ”¾æ¾">ä¼‘é—²æ”¾æ¾</span>
                    <span class="preference-tag" data-value="æ‘„å½±è‰ºæœ¯">æ‘„å½±è‰ºæœ¯</span>
                    <span class="preference-tag" data-value="å¤œç”Ÿæ´»">å¤œç”Ÿæ´»</span>
                </div>
            </div>
            <div class="form-section">
                <h3 class="section-title">ğŸ¨ ä½å®¿åå¥½</h3>
                <div class="form-group">
                    <select class="form-control" id="accommodation_type" required>
                        <option value="">è¯·é€‰æ‹©ä½å®¿ç±»å‹</option>
                        <option value="è±ªåé…’åº—">è±ªåé…’åº—</option>
                        <option value="ç²¾å“é…’åº—">ç²¾å“é…’åº—</option>
                        <option value="å•†åŠ¡é…’åº—">å•†åŠ¡é…’åº—</option>
                        <option value="ç»æµå‹é…’åº—">ç»æµå‹é…’åº—</option>
                        <option value="æ°‘å®¿/å…¬å¯“">æ°‘å®¿/å…¬å¯“</option>
                        <option value="é’å¹´æ—…ç¤¾">é’å¹´æ—…ç¤¾</option>
                    </select>
                </div>
            </div>
            <div class="form-section">
                <h3 class="section-title">ğŸš— äº¤é€šåå¥½</h3>
                <div id="transportation" class="preference-tags">
                    <span class="preference-tag" data-value="é£æœº">é£æœº</span>
                    <span class="preference-tag" data-value="é«˜é“">é«˜é“</span>
                    <span class="preference-tag" data-value="ç§Ÿè½¦">ç§Ÿè½¦</span>
                    <span class="preference-tag" data-value="å…¬å…±äº¤é€š">å…¬å…±äº¤é€š</span>
                    <span class="preference-tag" data-value="å‡ºç§Ÿè½¦/ç½‘çº¦è½¦">å‡ºç§Ÿè½¦/ç½‘çº¦è½¦</span>
                    <span class="preference-tag" data-value="æ­¥è¡Œ">æ­¥è¡Œ</span>
                </div>
            </div>
            <div class="form-section">
                <h3 class="section-title">ğŸ½ï¸ é¥®é£Ÿè¦æ±‚</h3>
                <div id="dietary_restrictions" class="preference-tags">
                    <span class="preference-tag" data-value="æ— ç‰¹æ®Šè¦æ±‚">æ— ç‰¹æ®Šè¦æ±‚</span>
                    <span class="preference-tag" data-value="ç´ é£Ÿ">ç´ é£Ÿ</span>
                    <span class="preference-tag" data-value="æ¸…çœŸ">æ¸…çœŸ</span>
                    <span class="preference-tag" data-value="æ— æµ·é²œ">æ— æµ·é²œ</span>
                    <span class="preference-tag" data-value="æ— è¾£">æ— è¾£</span>
                    <span class="preference-tag" data-value="ä½ç›">ä½ç›</span>
                </div>
            </div>
            <button type="submit" class="plan-button" id="planButton">âœ¨ å¼€å§‹åˆ¶å®šæ—…è¡Œè®¡åˆ’</button>
        </form>
    </aside>

    <!-- å³ä¾§èŠå¤©é¢æ¿ -->
    <main class="travel-chat-panel">
        <header class="travel-header">
            <h2>
                <img src="{{ url_for('static', filename='icon.png') }}" alt="é’é¸¾å‘å¯¼" class="logo-small" style="width: 30px; height: 30px; border-radius: 50%;">
                AIæ—…è¡Œè§„åˆ’åŠ©æ‰‹
            </h2>
            <nav class="nav-actions">
                <a href="{{ url_for('chat') }}" class="nav-btn">èŠå¤©åŠ©æ‰‹</a>

                <div class="user-box">
                    <span class="user-email" title="{{ email }}">{{ email }}</span>
                    <a href="{{ url_for('logout') }}" class="logout-btn">é€€å‡º</a>
                </div>
            </nav>


        </header>
        <div class="quick-actions">
            <button class="quick-action-btn" onclick="askQuickQuestion('è¯·è¯¦ç»†ä»‹ç»æ¨èçš„æ™¯ç‚¹')">ğŸ›ï¸ æ™¯ç‚¹è¯¦æƒ…</button>
            <button class="quick-action-btn" onclick="askQuickQuestion('è¯·æ¨èæ›´å¤šå½“åœ°ç¾é£Ÿå’Œé¤å…')">ğŸœ ç¾é£Ÿæ¨è</button>
            <button class="quick-action-btn" onclick="askQuickQuestion('è¯·ä¼˜åŒ–æˆ‘çš„é¢„ç®—åˆ†é…')">ğŸ’° é¢„ç®—ä¼˜åŒ–</button>
            <button class="quick-action-btn" onclick="askQuickQuestion('è¯·è°ƒæ•´è¡Œç¨‹æ—¶é—´å®‰æ’')">â° è¡Œç¨‹è°ƒæ•´</button>
            <button class="quick-action-btn" onclick="showAttractionGuideDialog()">ğŸ¯ æ™¯ç‚¹è®²è§£</button>
            <button class="quick-action-btn export-pdf-btn" onclick="exportToPDF()" id="exportPdfBtn">ğŸ“„ å¯¼å‡ºPDFæŠ¥å‘Š</button>
        </div>
        <section class="chat-box" id="chat-box">
            <!-- èŠå¤©å†…å®¹ -->
        </section>
        <footer class="input-area">
            <textarea id="message-input" placeholder="æœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥éšæ—¶è¯¢é—®..." rows="2" disabled></textarea>
            <button id="send-btn1" onclick="sendMessage()" disabled>å‘é€</button>
        </footer>
    </main>
</div>

<!-- æ™¯ç‚¹è®²è§£å¯¹è¯æ¡† -->
<div id="attractionGuideModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ›ï¸ æ™¯ç‚¹è®²è§£åŠ©æ‰‹</h3>
            <span class="close" onclick="closeAttractionGuideDialog()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">ğŸ¯ è¯·è¾“å…¥æ‚¨æƒ³äº†è§£çš„æ™¯ç‚¹åç§°ï¼š</label>
                <input type="text" class="form-control" id="attractionInput" placeholder="ä¾‹ï¼šæ•…å®«ã€è¥¿æ¹–ã€å¤©å®‰é—¨ã€é•¿åŸç­‰">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ¨ é€‰æ‹©è®²è§£é£æ ¼ï¼š</label>
                <select class="form-control" id="guideStyleSelect">
                    <option value="å­¦æœ¯å‹">ğŸ“š å­¦æœ¯å‹ï¼ˆä¸¥è°¨ä¸“ä¸šï¼Œè€ƒå¤ä¸“å®¶è§†è§’ï¼‰</option>
                    <option value="æ•…äº‹å‹">ğŸ“– æ•…äº‹å‹ï¼ˆç”ŸåŠ¨æœ‰è¶£ï¼Œè¯´ä¹¦äººé£æ ¼ï¼‰</option>
                    <option value="äº²å­å‹">ğŸ‘¶ äº²å­å‹ï¼ˆç®€å•æ˜“æ‡‚ï¼Œé€‚åˆå„¿ç«¥ï¼‰</option>
                    <option value="ç½‘çº¢é£æ ¼">ğŸ“¸ ç½‘çº¢é£æ ¼ï¼ˆæ—¶å°šæœ‰è¶£ï¼Œæ‹ç…§æ”»ç•¥ï¼‰</option>
                    <option value="å¹½é»˜è¯™è°">ğŸ˜„ å¹½é»˜è¯™è°ï¼ˆè½»æ¾æç¬‘ï¼Œç½‘ç»œç”¨è¯­ï¼‰</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ–¼ï¸ å›¾ç‰‡ç”Ÿæˆè®¾ç½®ï¼š</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="generateImageCheckbox" checked>
                        <span class="checkmark"></span>
                        è‡ªåŠ¨ç”Ÿæˆæ™¯ç‚¹å›¾ç‰‡ï¼ˆAIåˆ›ä½œï¼Œå±•ç°æ™¯ç‚¹é­…åŠ›ï¼‰
                    </label>
                    <div class="image-info">
                        <small>ğŸ’¡ å¼€å¯åå°†ä¸ºæ‚¨ç”Ÿæˆé«˜è´¨é‡çš„æ™¯ç‚¹è§†è§‰å›¾ç‰‡</small>
                        <small style="display: block; margin-top: 4px; color: #666;">
                            ï¿½ï¸ å›¾ç‰‡å°†ç›´æ¥æ˜¾ç¤ºåœ¨ç½‘é¡µä¸­ï¼Œæ”¯æŒç‚¹å‡»æ”¾å¤§
                        </small>
                        <small style="display: block; margin-top: 2px; color: #888;">
                            ï¿½ åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨æä¾›åŸå§‹å›¾ç‰‡é“¾æ¥
                        </small>
                    </div>
                </div>
            </div>
            <!-- ä¿®æ”¹ travel.html ä¸­çš„æŒ‰é’®éƒ¨åˆ† -->
            <div class="modal-actions">
                <button class="modal-action-btn modal-action-cancel" onclick="closeAttractionGuideDialog()">
                    <span>å–æ¶ˆ</span>
                </button>
                <button class="modal-action-btn modal-action-confirm" onclick="startAttractionGuideFromModal()">
                    <span>å¼€å§‹è®²è§£</span>
                </button>
            </div>
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='travel.js') }}"></script>

<!-- å›¾ç‰‡åŠ è½½ä¼˜åŒ– -->
<style>
/* å›¾ç‰‡å®¹å™¨æ ·å¼ */
.image-container {
    position: relative;
    display: inline-block;
    margin: 15px 0;
    text-align: center;
}

.image-container img {
    transition: opacity 0.3s ease, transform 0.2s ease;
    cursor: pointer;
}

.image-container img:hover {
    transform: scale(1.05);
}

/* å›¾ç‰‡åŠ è½½çŠ¶æ€ */
.image-loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* å›¾ç‰‡é”™è¯¯çŠ¶æ€ */
.image-error {
    border: 2px dashed #ccc;
    background-color: #f9f9f9;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 200px;
    text-align: center;
}

/* å›¾ç‰‡é“¾æ¥æ ·å¼ */
.image-link {
    display: inline-block;
    margin-top: 8px;
    padding: 4px 8px;
    background-color: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 12px;
    transition: background-color 0.2s ease;
}

.image-link:hover {
    background-color: #0056b3;
    color: white;
    text-decoration: none;
}

/* å›¾ç‰‡æ¨¡æ€æ¡† */
.image-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    cursor: pointer;
}

.image-modal img {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
}

.image-modal .close {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 30px;
    cursor: pointer;
}
</style>

<script>
// å›¾ç‰‡åŠ è½½ä¼˜åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ç›‘å¬æ¶ˆæ¯å†…å®¹å˜åŒ–ï¼Œä¸ºæ–°æ·»åŠ çš„å›¾ç‰‡æ·»åŠ ä¼˜åŒ–
    const chatBox = document.getElementById('chat-box');
    
    if (chatBox) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            optimizeImages(node);
                        }
                    });
                }
            });
        });
        
        observer.observe(chatBox, {
            childList: true,
            subtree: true
        });
        
        // åˆå§‹åŒ–å·²å­˜åœ¨çš„å›¾ç‰‡
        optimizeImages(chatBox);
    }
});

function optimizeImages(container) {
    const images = container.querySelectorAll('img');
    
    images.forEach(function(img) {
        if (img.dataset.optimized) return; // é¿å…é‡å¤å¤„ç†
        
        img.dataset.optimized = 'true';
        
        // æ·»åŠ åŠ è½½çŠ¶æ€
        img.classList.add('image-loading');
        
        // å›¾ç‰‡åŠ è½½æˆåŠŸ
        img.addEventListener('load', function() {
            img.classList.remove('image-loading');
            img.style.opacity = '1';
            console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', img.src);
        });
        
        // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤„ç†
        img.addEventListener('error', function() {
            img.classList.remove('image-loading');
            console.log('å›¾ç‰‡åŠ è½½å¤±è´¥:', img.src);
            
            // å¦‚æœæœ‰onerrorå±æ€§ï¼Œè®©å®ƒå…ˆæ‰§è¡Œ
            if (img.getAttribute('onerror') && !img.dataset.errorHandled) {
                img.dataset.errorHandled = 'true';
                return;
            }
            
            // åˆ›å»ºé”™è¯¯æç¤º
            const errorDiv = document.createElement('div');
            errorDiv.className = 'image-error';
            errorDiv.innerHTML = `
                <div>
                    <p>ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥</p>
                    <p style="font-size: 12px; margin-top: 5px;">ç½‘ç»œå¯èƒ½å—é™ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æŸ¥çœ‹</p>
                </div>
            `;
            
            // æ›¿æ¢å›¾ç‰‡
            img.parentNode.replaceChild(errorDiv, img);
        });
        
        // æ·»åŠ ç‚¹å‡»æ”¾å¤§åŠŸèƒ½
        img.addEventListener('click', function() {
            showImageModal(img.src, img.alt);
        });
        
        // ä¸ºå›¾ç‰‡æ·»åŠ æ‡’åŠ è½½
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                        }
                        observer.unobserve(img);
                    }
                });
            });
            
            imageObserver.observe(img);
        }
    });
}

function showImageModal(src, alt) {
    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `
        <span class="close">&times;</span>
        <img src="${src}" alt="${alt}">
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'block';
    
    // å…³é—­æ¨¡æ€æ¡†
    modal.addEventListener('click', function() {
        document.body.removeChild(modal);
    });
    
    modal.querySelector('.close').addEventListener('click', function() {
        document.body.removeChild(modal);
    });
}
</script>
</body>
</html>
